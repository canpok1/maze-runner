---
description: ユーザーストーリーの各タスクの対応状況を確認し、マージ可能なPRのマージと着手可能タスクへのラベル付与を行います。
argument-hint: [ユーザーストーリーのIssue番号]
---

## 概要

ユーザーストーリーのサブIssue（タスク）の進捗状況を確認し、以下のアクションを実行するスキルです:
- マージ可能なPRの自動マージ（ユーザー確認不要）
- 着手可能タスクへの `assign-to-claude` ラベル付与（ユーザー確認後）

## 手順

### フェーズ1: 情報収集

1. ユーザーストーリーのIssue番号を確認する。
    - `$ARGUMENTS` で指定されている場合、この手順はスキップする。
    - 指定されていない場合はユーザーに確認する。
2. リポジトリのオーナーとリポジトリ名を `git remote` から取得する。
3. `github` スキル（`issue-sub-issues.sh`）でサブIssue一覧を取得する。
4. 各サブIssueについて以下の情報を取得する:
    - `github` スキル（`issue-get.sh`）でIssue詳細（state, labels, body）を取得する。
    - `github` スキル（`pr-search.sh`）で対応するPRを検索する。以下の順序でフォールバック検索を行う。タイトル検索でヒットした場合はそれを使用し、ヒットしなかった場合のみ本文検索を実行する:
        1. タイトル検索: クエリ `{サブIssue番号} in:title`
        2. 本文検索: クエリ `{サブIssue番号} in:body`
            - PRの本文に `fixed #{番号}` や `closes #{番号}` が含まれるケースに対応
    - 複数PRがヒットした場合は、openな最新PRを対象とする。
    - PRが存在する場合、`github` スキル（`pr-get.sh`）でPR詳細を取得する。
    - PRが存在する場合、`github` スキル（`pr-status.sh`）でCI状態を取得する。
    - PRが存在する場合、`github` スキル（`thread-list.sh`）でレビューコメントのスレッド一覧を取得する。
    - `github` スキル（`thread-details.sh`）で各スレッドの解決状態を取得する。
    - 未解決のスレッドが存在するか確認する。

### フェーズ2: 状態分類

各サブIssueを以下のカテゴリに分類する:

1. **完了済み**: state が 'closed'
2. **PR作成済み・マージ可能**: 以下の条件をすべて満たす
    - PRが存在する
    - PRのstate が 'open'
    - PR作成から5分以上経過している（AIによる自動レビューの完了を待つため）
    - CI（GitHub Actions）がすべてpass（成功）している（チェックが0件の場合もpassとみなす）
    - マージコンフリクトがない（mergeable が true）
    - 未解決のレビューコメント（unresolved review threads）が存在しない
3. **PR作成済み・マージ不可**: PRが存在するがマージ可能の条件を満たさない
    - マージ不可の理由を記録する（CI失敗/レビュー待ち/コンフリクト/未解決レビューコメントあり等）
4. **作業中**: `in-progress-by-claude` ラベルが付与されている
5. **アサイン済み**: `assign-to-claude` ラベルが付与されているが作業中ではない
6. **未着手・着手可能**: 以下の条件をすべて満たす
    - state が 'open'
    - `assign-to-claude` および `in-progress-by-claude` ラベルがない
    - 依存タスクがすべて完了している（後述の依存関係解析を参照）
7. **未着手・依存未解決**: 未着手だが依存タスクに未完了のものがある

### フェーズ3: 依存関係の解析

各サブIssueの本文から依存関係を抽出する:

1. Issue本文の「依存関係」または「## 依存関係」セクションを検索する。
2. セクション内から `#数字` パターンを抽出する。
3. 以下の記載がある場合は依存なしと判定する:
    - 「なし」
    - 「並列着手可能」
    - セクション内にIssue番号の記載がない
4. 依存先タスクの状態を確認し、すべて完了（closed）しているかをチェックする。

### フェーズ4: アクション実行

#### ステップ4-1: マージ可能PRの処理

1. 「PR作成済み・マージ可能」に分類されたPRを自動でマージする（ユーザー確認不要）:
    - `github` スキル（`pr-merge.sh`）でマージする。merge_method: 'squash' を使用する。
    - マージ結果を記録する。成功したPRの一覧（Issue番号、タイトル、PR番号、PR URL）と、失敗したPRがあればその理由を報告する。
2. マージに成功したPRに対応するIssueについて、自動クローズ処理を行う:
    - フェーズ1で収集した各サブIssueとPRの対応関係から、該当するIssue番号を取得する。
    - `github` スキル（`issue-get.sh`）でIssueのstateを確認する。
    - Issueがまだオープンの場合:
        - `github` スキル（`issue-add-comment.sh`）でIssueにコメント（例: "Merged via PR #{マージしたPR番号}"）を追加する。
        - `github` スキル（`issue-update.sh`）でIssueをクローズする（`--state closed --state-reason completed`）。
    - Issueが既にクローズ済みの場合は何もしない。

#### ステップ4-2: 着手可能タスクの再評価

1. マージによりIssueがcloseされるため、依存関係を再計算する。
2. 新たに着手可能になったタスクを特定する。

#### ステップ4-3: 着手可能タスクへのラベル付与

1. 「未着手・着手可能」に分類されたタスクの一覧を提示する:
    - Issue番号、タイトル、URL
2. 以下を実行する:
    - `github` スキル（`issue-get.sh`）で現在のラベル一覧を取得する。
    - 既存ラベルに `assign-to-claude` を追加した配列を作成する。
    - `github` スキル（`issue-update.sh`）でラベルを更新する。
3. ラベル付与結果を記録する（成功/失敗）。

### フェーズ5: ステータス報告

以下の情報をサマリー形式でユーザーに報告する:

- 全タスク数と完了タスク数（例: 完了 5/10）
- 今回マージしたPR数とその一覧
- 今回ラベルを付与したタスク数とその一覧
- カテゴリ別のタスク分布:
    - 完了済み: X件
    - PR作成済み・マージ可能: X件
    - PR作成済み・マージ不可: X件（理由も表示）
    - 作業中: X件
    - アサイン済み: X件
    - 未着手・着手可能: X件
    - 未着手・依存未解決: X件

### フェーズ6: 受け入れ条件チェック（全タスク完了時のみ）

全サブIssueが完了済みの場合のみ、このフェーズを実行する。

1. ユーザーストーリー（親Issue）の本文から「受け入れ条件」セクションを取得する。
2. 各受け入れ条件について、完了したサブIssueの実装内容・PR内容を踏まえて充足しているか判定する。
3. 判定結果をユーザーに報告する:
    - 充足している条件: チェックマーク付きで一覧表示
    - 未充足の条件: 理由とともに一覧表示
4. 未充足の受け入れ条件がある場合:
    - 未充足の条件を満たすための追加タスクIssueを作成する（`github` スキル: `issue-create.sh`）。
      - タイトル: 受け入れ条件の内容を反映した簡潔なタスク名
      - 本文: 未充足の理由、必要な対応内容、親ストーリーへの参照を含める
    - 作成したIssueをサブIssueとして親ストーリーに追加する（`github` スキル: `sub-issue-add.sh`）。
    - 作成したIssueに `assign-to-claude` ラベルを付与してよいかユーザーに確認する（AskUserQuestion を使用）。
    - ユーザーが承認した場合、以下を実行する:
      - `github` スキル（`issue-get.sh`）で現在のラベル一覧を取得する。
      - 既存ラベルに `assign-to-claude` を追加した配列を作成する。
      - `github` スキル（`issue-update.sh`）でラベルを更新する。
5. 全受け入れ条件が充足している場合:
    - ユーザーストーリーの完了をユーザーに報告する。
    - コマンドを実行したユーザーを、ユーザーストーリーの github issue の assignees に追加する。
    - ユーザーに受け入れ条件の手動チェック（動作確認）を依頼する。
      - ストーリーのURLと受け入れ条件の一覧を提示し、実際に動作確認を行うよう案内する。
      - ストーリーにユーザーをアサインした旨も報告する。

## 注意点

- ラベル付与は必ずユーザー確認後に実行すること（AskUserQuestion を使用）。
- ラベル付与時は既存のラベルを保持して `assign-to-claude` を追加すること。
- PR検索で複数ヒットした場合は、openな最新PRを対象とすること。
- マージには merge_method: 'squash' を使用すること。
- リポジトリのオーナーとリポジトリ名は `git remote` から取得すること。
- 依存関係の解析は Issue本文の「依存関係」セクションに基づいて行うこと。
- CI状態の確認では、すべてのチェックがpassしていることを確認すること（チェックが0件の場合もpassとみなす）。
- 未解決レビューコメントの確認では、`thread-list.sh` でスレッド一覧を取得し、`thread-details.sh` で各スレッドの解決状態を確認すること。
- PRマージ後のIssue自動クローズでは、Issueが既にクローズ済みの場合はスキップすること。
- エラーが発生した場合は、詳細な情報をユーザーに報告すること。
