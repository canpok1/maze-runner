---
description: プルリクエストのCI状態とレビューコメントを確認し、必要に応じて対応し、コメントに返信します。完了条件達成後はPRを自動マージします。
---
## 手順
1. プルリクエストの番号を特定する。
    - `github` スキルを参照し、現在のブランチからPR番号を取得する。
    - PRが存在しない場合はユーザーに報告し、作業を中断する。
2. PRブランチがベースブランチより遅れていないか確認する。
    - `github` スキルを使用してPRの状態を確認し、behind状態かどうかを把握する。
    - 遅れている場合、ベースブランチをマージする。
3. CIの終了を待機する。
    - `github` スキル（`pr-checks-watch.sh`）を使用してPRの全チェックが完了するまで待機する。
4. `github` スキルを使用してCIの結果を詳細に把握する。
    - 失敗していた場合、ワークフローのログを確認して失敗の原因を分析する。
    - 一時的な問題（インフラ障害、flaky test等）と判断した場合は、`gh run rerun <run-id>` で失敗したワークフローを再実行し、手順3に戻ってCIの完了を再度待機する。ただし、同一ワークフローの再実行は最大2回までとし、2回とも失敗した場合はコード修正が必要と判断する。
    - コード修正が必要な場合は、対応方針を決めて手順7で修正する。
5. `github` スキルを使用してレビューコメントを把握する。
    - 未解決のレビューコメントがある場合、以下の手順で対応方針を決める。
        1. `github` スキルを使用してスレッドの詳細を把握する。
        2. スレッド情報を元に方針を決める。
            - 改修提案かつ対応が必要な場合: コード修正と返信が必要と判断する。
            - 改修提案かつ対応が不要な場合: 対応不要な理由を添えて返信が必要と判断する。
            - 対応内容が承認された場合: スレッドのResolveが必要と判断する。
            - IsOutdated=true かつ改修提案への対応済み（コード修正・返信完了）の場合: スレッドのResolveが必要と判断する。
6. 承認済みスレッドおよびoutdated対応済みスレッドの resolve を行う。
    - 手順5で「スレッドのResolveが必要」と判断したスレッド（承認済み・outdated対応済みの両方）を確認する。
    - 該当するスレッドを全て resolve する。
7. 手順4と5で決めた方針に従って対応を行う。
    - CI失敗への対応とレビューコメントへのコード修正をまとめて行い、コミット・プッシュする。
    - 各レビューコメントスレッドへ返信を行う。
8. 完了条件を満たしているか確認する。
    - CIが未完了の場合は、`github` スキル（`pr-checks-watch.sh`）を使用してCIの完了を待機してから手順2に戻る。
    - CI以外の完了条件（レビュースレッドの解決など）を満たしていない場合は、未完了の条件をユーザーに報告してから30秒待機し、手順2に戻る。
    - ただし、手順2からの再実施は最大10回まで繰り返し、10回を超えた場合はユーザーに報告し、作業を中断する。
9. 完了条件を全て満たしたら、PRのマージを行う。
    - `github` スキル（`pr-merge.sh`）を使用してPRのマージを試みる。マージ方式は指定しない（リポジトリのデフォルト設定に従う）。
    - マージに成功した場合、マージが完了した旨をユーザーに報告する。
    - マージに失敗した場合、マージできなかった旨とその理由をユーザーに報告し、作業を中断する。

## 完了条件

以下の全てを満たすこと：
- [ ] PRブランチがベースブランチに対して遅れていない（behind状態でない）
- [ ] outdatedのものも含め、レビュースレッドが全て resolve されている
- [ ] 改修提案への対応が完了し、返信済み
- [ ] 対応不要なコメントへの返信が完了している
- [ ] CI が全て成功している

## 注意点
- 承認されるまではResolveすることは禁止
  - ただし、IsOutdated=true かつ改修提案への対応済み（コード修正・返信完了）のスレッドは例外としてResolve可能
- 返信時はスレッドの投稿者全員に対してメンションすること
- マージ後にブランチの自動削除は行わない
