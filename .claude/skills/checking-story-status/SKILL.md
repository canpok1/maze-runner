---
name: checking-story-status
description: ユーザーストーリーの各サブIssueの進捗状況を確認し、マージ可能なPRを自動マージして着手可能タスクに `assign-to-claude` ラベルを付与します。ストーリーの進捗確認やタスクの自動化を行う場合に使用してください。
argument-hint: [ユーザーストーリーのIssue番号]
---

## 手順

このチェックリストをコピーし、進行状況の追跡に使用してください：

タスク進捗：
- [ ] フェーズ1：情報収集
- [ ] フェーズ2：状態分類
- [ ] フェーズ3：依存関係の解析
- [ ] フェーズ4：アクション実行（マージ・ラベル付与）
- [ ] フェーズ5：ステータス報告
- [ ] フェーズ6：受け入れ条件チェック（全タスク完了時のみ）

### フェーズ1: 情報収集

1. ユーザーストーリーのIssue番号を確認（`$ARGUMENTS` で指定されていない場合はユーザーに確認）
2. リポジトリのオーナーとリポジトリ名を `git remote` から取得
3. `issue-sub-issues.sh`でサブIssue一覧を取得
4. 各サブIssueについて以下の情報を取得する:
    - `issue-get.sh`: Issue詳細（state, labels, body）
    - `pr-search.sh`: PRを検索（タイトル検索 `{Issue番号} in:title` → 本文検索 `{Issue番号} in:body` の順）。複数ヒット時はopenな最新PRを使用
    - `pr-get.sh`: PR詳細
    - `pr-status.sh`: CI状態
    - `thread-list.sh`, `thread-details.sh`: レビューコメントのスレッド一覧と解決状態

### フェーズ2: 状態分類

各サブIssueを以下のカテゴリに分類する:

1. **完了済み**: state が 'closed'
2. **PR作成済み・マージ可能**:
    - state が 'open'
    - PR作成から5分以上経過
    - CIがすべてpass（チェック0件の場合もpass）
    - コンフリクトなし（mergeable が true）
    - 未解決レビューコメントなし
3. **PR作成済み・マージ不可**: PRがあるが上記を満たさない（理由を記録）
4. **作業中**: `in-progress-by-claude` ラベルあり
5. **アサイン済み**: `assign-to-claude` ラベルあり（作業中除く）
6. **未着手・着手可能**: state が 'open'、両ラベルなし、依存タスク完了済み
7. **未着手・依存未解決**: 未着手だが依存タスクに未完了あり

### フェーズ3: 依存関係の解析

各サブIssueの本文から依存関係を抽出:

1. Issue本文の「依存関係」または「## 依存関係」セクションを検索
2. セクション内から `#数字` パターンを抽出
3. 「なし」「並列着手可能」またはIssue番号なしの場合は依存なしと判定
4. 依存先タスクがすべて完了（closed）しているか確認

### フェーズ4: アクション実行

#### ステップ4-1: マージ可能PRの処理

1. `pr-merge.sh`で自動マージ（merge_method: 'squash'、ユーザー確認不要）。結果を記録
2. マージ成功したPRに対応するIssueを自動クローズ:
    - `issue-get.sh`でstate確認
    - オープンの場合: `issue-add-comment.sh`でコメント追加 → `issue-update.sh`でクローズ（`--state closed --state-reason completed`）
    - 既にクローズ済みの場合はスキップ

#### ステップ4-2: 着手可能タスクの再評価

マージによりIssueがcloseされるため、依存関係を再計算し新たに着手可能なタスクを特定。

#### ステップ4-3: 着手可能タスクへのラベル付与

1. 「未着手・着手可能」タスク一覧を提示（Issue番号、タイトル、URL）
2. `issue-get.sh`で現在のラベル取得 → 既存ラベルに `assign-to-claude` を追加 → `issue-update.sh`で更新
3. 付与結果を記録

### フェーズ5: ステータス報告

サマリー形式でユーザーに報告:
- 完了タスク数 / 全タスク数
- マージしたPR数と一覧
- ラベル付与したタスク数と一覧
- カテゴリ別タスク分布（完了済み、PR作成済み・マージ可能、PR作成済み・マージ不可（理由付き）、作業中、アサイン済み、未着手・着手可能、未着手・依存未解決）

### フェーズ6: 受け入れ条件チェック（全タスク完了時のみ）

全サブIssueが完了済みの場合のみ実行:

1. 親Issueの本文から「受け入れ条件」セクションを取得
2. 各条件が完了したサブIssue・PRの内容で充足しているか判定
3. 判定結果を報告（充足: チェックマーク付き、未充足: 理由付き）
4. 未充足の受け入れ条件がある場合:
    - 追加タスクIssueを作成（`issue-create.sh`、`--label task`）
    - `sub-issue-add.sh`で親ストーリーに追加
    - `assign-to-claude` ラベル付与をユーザーに確認（AskUserQuestion）
    - 承認時: `issue-get.sh`で既存ラベル取得 → `assign-to-claude` 追加 → `issue-update.sh`で更新
5. 全受け入れ条件が充足している場合:
    - ユーザーストーリーの完了を報告
    - ユーザーをIssueのassigneesに追加
    - ユーザーに手動チェック（動作確認）を依頼（ストーリーURL、受け入れ条件一覧、アサイン完了を報告）
