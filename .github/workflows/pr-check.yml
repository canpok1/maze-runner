name: PR Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  pull-requests: write

jobs:
  pr-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'package.json'
          cache: 'npm'
      - name: Setup
        run: npm run setup
      - name: Lint
        run: npm run lint
      - name: Test
        run: npm test
      - name: Build
        run: npm run build
      - name: E2E Test
        run: npm run test:e2e

  schema-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate SQL syntax
        run: |
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          if [ ! -d "backend/db/migrations" ]; then
            echo "No migrations directory found"
            exit 0
          fi

          # SQLãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€è¦§ã‚’å–å¾—ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åé †ã«ã‚½ãƒ¼ãƒˆï¼‰
          sql_files=$(find backend/db/migrations -name "*.sql" -type f | sort)

          if [ -z "$sql_files" ]; then
            echo "No SQL files found"
            exit 0
          fi

          # å…¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é †ç•ªã«é©ç”¨ã—ã¦æ¤œè¨¼
          echo "Validating SQL migration files..."

          # ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          temp_db=$(mktemp)
          trap "rm -f $temp_db" EXIT

          for file in $sql_files; do
            echo "Applying $file..."
            if sqlite3 "$temp_db" < "$file" 2>&1; then
              echo "âœ… $file applied successfully"
            else
              echo "âŒ Error in $file"
              echo ""
              echo "SQL syntax validation failed"
              exit 1
            fi
          done

          echo ""
          echo "All SQL files are valid"

  preview-deploy:
    needs: pr-check
    runs-on: ubuntu-latest
    environment:
      name: preview
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'package.json'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload Worker Version
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4.21.0"
          workingDirectory: backend
          command: versions upload --preview-alias pr-${{ github.event.pull_request.number }}

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.deploy.outputs.deployment-url }}';
            const commitHash = '${{ github.event.pull_request.head.sha }}';
            const branchName = '${{ github.event.pull_request.head.ref }}';

            const commentBody = `<!-- preview-comment -->
            ## ğŸš€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†

            ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸï¼

            **ğŸ”— ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL:** ${previewUrl}

            **ğŸ“ è©³ç´°æƒ…å ±:**
            - **ã‚³ãƒŸãƒƒãƒˆ:** \`${commitHash.substring(0, 7)}\`
            - **ãƒ–ãƒ©ãƒ³ãƒ:** \`${branchName}\`
            - **PRç•ªå·:** #${{ github.event.pull_request.number }}
            `;

            // æ—¢å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(comment =>
              comment.body?.includes('<!-- preview-comment -->')
            );

            if (existingComment) {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody,
              });
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
            }
